<div class="history-timeline dx-card">
  <div *ngIf="groupedHistory.length; else noHistory" class="timeline">
    <div *ngFor="let group of groupedHistory; let i = index" class="timeline-group">
      <div class="timeline-date">
        <span class="date-dot"></span>
        <span class="date-text">{{ group.date }}</span>
      </div>
      <div *ngFor="let item of group.entries; let j = index; let last = last" class="timeline-entry">
        <div class="timeline-time">{{ getTimeOnly(item.timestamp) }}</div>
        <div class="timeline-dot">
          <div class="dot" [class.active]="i === 0 && j === 0"></div>
          <div class="line" *ngIf="!last"></div>
        </div>
        <div class="timeline-content">
 
          <!-- START OF MODIFICATION -->
 
          <!-- Display for the initial creation event -->
          <div *ngIf="item.isInitial">
            <div class="user-action">
              <!-- We only show the 'fromStage' which now contains the full message -->
              <strong>{{ item.fromStage }}</strong>
            </div>
            <!-- The 'toStage' is displayed below as the stage name -->
            <div class="stage-change initial-stage">
              {{ item.toStage }}
            </div>
          </div>
 
          <!-- Display for all subsequent stage updates -->
          <div *ngIf="!item.isInitial">
            <div class="user-action">
              <strong>Stage updated by {{ item.editedBy }}</strong>
            </div>
            <div class="stage-change">
              {{ item.fromStage }} to {{ item.toStage }}
            </div>
          </div>
 
          <!-- END OF MODIFICATION -->
 
        </div>
      </div>
    </div>
  </div>
  <ng-template #noHistory>
    <div class="no-history">No stage history available.</div>
  </ng-template>
</div>